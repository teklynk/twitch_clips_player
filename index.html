<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Twitch Clips Player</title>
    <meta name="description"
        content="This is a Twitch Clips Player, browser source overlay for OBS. Automatically play clips from your channel or other channels. Keep your viewers entertained on your BRB or starting soon scenes." />
    <meta name="keywords" content="Twitch, clips player, overlay" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Twitch Clips Player" />
    <meta property="og:description"
        content="This is a Twitch Clips Player, browser source overlay for OBS. Automatically play clips from your channel or other channels. Keep your viewers entertained on your BRB or starting soon scenes." />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="Twitch Clips Player" />
    <script src="assets/js/jquery-3.6.0.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="assets/css/bootstrap452.min.css">
    <link rel="stylesheet" href="assets/css/dark.min.css">
    <link rel="apple-touch-icon" sizes="57x57" href="assets/images/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="assets/images/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="assets/images/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/images/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="assets/images/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/images/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="assets/images/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/images/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/images/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="assets/images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon-16x16.png">
</head>
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Noto Sans, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        background-color: #181821;
        color: #ddd9e8 !important;
    }

    .card, .alert {
        background-color: #292938 !important;
        border-color: #292938 !important;
        color: #ddd9e8 !important;
    }

    .hide {
        display: none;
    }

    .ml-0 {
        margin-left: 0 !important;
    }

    .ml-4 {
        margin-left: 1.5rem !important;
    }

    .pl-0 {
        padding-left: 0 !important;
    }

    .pr-0 {
        padding-right: 0 !important;
    }

    .dark-blue {
        background-color: #1b2836 !important;
        color: #fff !important;
    }

    .light-blue {
        background-color: #354e69 !important;
        color: #fff !important;
    }
</style>

<body onload="onInit()">
    <div class="container">
        <div class="row pt-md-4 mb-4">
            <ul class="nav nav-pills">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle active" data-toggle="dropdown" href="#" role="button"
                        aria-haspopup="true" aria-expanded="false">Twitch Tools</a>
                    <div class="dropdown-menu" id="main-nav">
                    </div>
                </li>
            </ul>
        </div>

        <div class="card mb-4">
            <div class="card-body shadow">
                <h2>Twitch Clips Player Overlay</h2>
                <p>This grabs your Twitch clips and plays them one after the other in a loop. Keep your viewers
                    entertained on your BRB or starting soon scenes.</p>
                <h3>Features:</h3>
                <ul>
                    <li><strong>Control your clips:</strong> Use !clipskip, !clippause, !clipplay, or !clipreload. Only
                        mods and streamer can use these commands.</li>
                    <li><strong>Show clips from channels that you follow.</strong></li>
                    <li><strong>Custom command:</strong> Start or stop the clip reel with a custom command. Command is
                        restricted to mods and streamer only.</li>
                    <li><strong>Type "!mycommand stop" in chat:</strong> Stop the clip reel without background play</li>
                    <li><strong>Show clip details panel:</strong> Open a panel displaying clip details about your
                        favorite clip. Use variables: {channel}, {title}, {game}, {creator_name}, {created_at} to change
                        the default text.</li>
                    <li><strong>Date Range:</strong> This will try to grab clips from within the last 5days, 10day, 30days... If no clips exist, then it will play a random "popular" clip.</li>
                    <li><strong>Prefer Featured Clips:</strong> This will try to grab featured clips. If no clips exist, then it will play a random "popular" clip.</li>
                </ul>
                <p>Be sure to set "Shutdown source when not visible", "Control audio via OBS", "Refresh browser when
                    scene becomes active" on the OBS Browser Source properties.</p>

                <div class="text-center p-1">
                    <a class="btn btn-dark btn-sm" href="https://github.com/teklynk/twitch_clips_player/blob/main/README.md" target="_blank">Help</a>
                    <a class="btn btn-dark btn-sm" href="https://github.com/teklynk/twitch_clips_player" target="_blank">GitHub</a>
                    <a class="btn btn-dark btn-sm" href="https://www.teklynk.com/support" target="_blank">Support</a>
                </div>
            </div>
        </div>

        <div class="alert alert-dark shadow" role="alert">Access Token is required if you would like to show clips from
            channels that you follow.<br>
            <div class="form-label-group">
                <div>
                    <a id="twitch-auth-link" href="#" target="_self"><img src="assets/images/connect.png"></a>
                </div>
                <div class="form-label-group mt-2">
                    <label for="ref">Access token</label>
                    <input type="password" id="ref" class="form-control">
                    <span id="show_ref"
                        style="cursor:pointer;text-align:left;display:inline-block;width:70px;margin-top: 4px;font-size:smaller;vertical-align:top;"
                        title="Show/Hide">show
                    </span>
                </div>
            </div>
        </div>

        <div class="form-label-group mb-4">
            <label for="mainChannel">Twitch Account</label>
            <input type="text" id="mainChannel" class="form-control shadow" value="" placeholder="MrCoolStreamer" size="50">
        </div>
        <div class="form-label-group mb-2">
            <label for="channel">Twitch channel(s) to pull clips from
                <small class="text-warning">* This can be a single channel or a comma separated list of channels</small>
            </label>
            <textarea id="channel" rows="3" class="form-control shadow" style="min-height: 100px;"
                placeholder="MrCoolStreamer,GamerGamingGames,StreamBean,AnotherStreamer,WillStreamForBeer"></textarea>
        </div>
        <div class="form-check mb-2">
            <input class="form-check-input shadow" type="checkbox" value="" id="showFollowing">
            <label class="form-check-label" for="showFollowing">
                Show clips from channels that you follow <small class="text-warning">* Requires Twitch Access
                    Token</small>
            </label>
        </div>
        <div class="form-label-group mb-2 hide" id="showExclude">
            <label for="exclude">Exclude channels
                <small class="text-warning">* Comma separated list of channels</small>
            </label>
            <textarea id="exclude" rows="3" class="form-control shadow" style="min-height: 100px;"
                placeholder="MrCoolStreamer,GamerGamingGames,StreamBean,AnotherStreamer,WillStreamForBeer"></textarea>
        </div>
        <div class="form-label-group mb-4" id="customCommandOptions">
            <div class="form-label-group mb-2">
                <label for="command">Custom Command <small>(Optional)</small>
                    <small class="text-warning">* If a custom command is Not set, the clips player will start playing as
                        soon as the scene is active.</small>
                </label>
                <input type="text" id="command" class="form-control shadow" value="" placeholder="playclips" size="50">
            </div>
        </div>
        <div class="form-group range-slider mt-4">
            <label for="limit">Max Number of clips to pull
                <small>(Max is 100)</small>
            </label>
            <input type="range" max="100" min="10" step="10" class="form-control range-slider-range shadow" id="limit"
                value="20" style="height: 0;">
            <small class="text-muted range-slider-value"></small>
            <small class="text-muted range-slider-value">Clips</small>
        </div>
        <div class="form-group range-slider mt-4">
            <label for="dateRange">Prefer clips from within a Date Range (Date range clips if found) <small
                    class="text-warning">* 0 Day(s) = OFF</small>
            </label>
            <input type="range" max="360" min="0" step="10" class="form-control range-slider-range shadow" id="dateRange"
                value="0" style="height: 0;">
            <small class="text-muted range-slider-value"></small>
            <small class="text-muted range-slider-value">Day(s)</small>
        </div>
        <div class="form-check mb-2">
            <input class="form-check-input shadow" type="checkbox" value="" id="preferFeatured">
            <label class="form-check-label" for="preferFeatured">
                Prefer featured clips (Featured clips if found)
            </label>
        </div>
        <div class="form-check mb-2">
            <input class="form-check-input shadow" type="checkbox" value="" id="showText" checked>
            <label class="form-check-label" for="showText">
                Show channel name on top of video
            </label>
        </div>
        <div class="form-label-group mt-2 mb-4 ml-4" id="showCustomText" checked>
            <label for="customText">Custom message <small>(Optional)</small>
            </label>
            <input type="text" id="customText" class="form-control shadow" value="" placeholder="Go check out {channel}"
                size="255">
        </div>
        <div class="form-check mb-2">
            <input class="form-check-input shadow" type="checkbox" value="" id="showDetails" checked>
            <label class="form-check-label" for="showDetails">
                Show clip details panel
            </label>
        </div>
        <div class="form-label-group mt-2 mb-4 ml-4" id="showDetailsText" checked>
            <label for="detailsText">Custom clip details panel text <small>(Optional)</small>
            </label>
            <textarea class="form-control shadow" id="detailsText" rows="4" placeholder="{title}
While streaming {game}
Clipped by {creator_name} {created_at}"></textarea>
        </div>
        <div class="form-group">
            <label for="themeOption">Theme options</label>
            <select class="form-control shadow" id="themeOption">
                <option value="0">None</option>
                <option value="1">Slide in fancy skewed</option>
                <option value="2" selected>Slide in basic</option>
                <option value="3">Outside the box</option>
            </select>
        </div>
        <br>
        <button class="btn btn-lg btn-success btn-block text-white shadow" id="generate_button" type="button">Generate Overlay
            Link</button>
        <br>
        <div id="overlaylink" class="hide"></div>
    </div>
    <div class="text-center p-1">
        <a class="btn btn-dark btn-sm" href="https://github.com/teklynk/twitch_clips_player/blob/main/README.md" target="_blank">Help</a>
        <a class="btn btn-dark btn-sm" href="https://github.com/teklynk/twitch_clips_player" target="_blank">GitHub</a>
        <a class="btn btn-dark btn-sm" href="https://www.teklynk.com/support" target="_blank">Support</a>
    </div>
    <div class="container text-center p-4">
        <small class="muted">Made with <span class="heart">â™¥</span> by <a href="https://www.teklynk.com" target="_blank">Teklynk</a></small>
    </div>
    <script>
        function onInit() {

            let url = window.location.href;
            let redirectUrl = window.location.origin + window.location.pathname;
            redirectUrl = redirectUrl.replace(/\/$/, "");

            // Update auth link
            let authLink = document.getElementById("twitch-auth-link");
            let clientId = "cuql1zod4eeabjr3cnc6adjn9ezro4";
            let scope = "chat:read+chat:edit+user:read:follows+moderator:read:followers";
            authLink.href = "https://id.twitch.tv/oauth2/authorize?response_type=token&client_id=" + clientId + "&redirect_uri=" + redirectUrl + "&scope=" + scope + "&force_verify=true";

            if (url.indexOf('#access_token') !== -1) {
                // extract the access_token from the url
                let access_token = new URL(url).hash.split('&').filter(function (el) {
                    if (el.match('access_token') !== null) return true;
                })[0].split('=')[1];
                // fill input with token value
                document.getElementById("ref").value = access_token;
                // Save token to localstorage
                localStorage.setItem("TwitchClipsRef", access_token);
                // Redirect to default page after getting token
                window.location.href = redirectUrl;
            } else {
                document.getElementById("ref").value = localStorage.getItem("TwitchClipsRef");
            }

            if (localStorage.getItem("TwitchClipsChannels")) {
                document.getElementById("channel").value = localStorage.getItem("TwitchClipsChannels");
            }

            if (localStorage.getItem("TwitchClipsMainChannel")) {
                document.getElementById("mainChannel").value = localStorage.getItem("TwitchClipsMainChannel");
            }
            if (localStorage.getItem("TwitchClipsCommand")) {
                document.getElementById("command").value = localStorage.getItem("TwitchClipsCommand");
            }
            if (localStorage.getItem("TwitchClipsCustomText")) {
                document.getElementById("customText").value = localStorage.getItem("TwitchClipsCustomText");
            }
            if (localStorage.getItem("TwitchClipsDetailsText")) {
                document.getElementById("detailsText").value = localStorage.getItem("TwitchClipsDetailsText");
            }
            if (localStorage.getItem("TwitchClipsThemeOption")) {
                document.getElementById("themeOption").value = localStorage.getItem("TwitchClipsThemeOption");
            }
            if (localStorage.getItem("TwitchClipsExclude")) {
                document.getElementById("exclude").value = localStorage.getItem("TwitchClipsExclude");
            }

            let rangeSlider = function rangeSlider() {
                let slider = $('.range-slider'),
                    range = $('.range-slider-range'),
                    value = $('.range-slider-value');

                slider.each(function () {

                    value.each(function () {
                        let value = $(this).prev().attr('value');
                        $(this).html(value);
                    });

                    range.on('input', function () {
                        $(this).next(value).html(this.value);
                    });
                });
            };

            // Auto grow textarea onload
            document.getElementById("channel").style.height = "";
            document.getElementById("channel").style.height = Math.min(document.getElementById("channel").scrollHeight, 300) + "px";

            rangeSlider();
        }

        // Auto grow textarea on input change
        document.getElementById("channel").oninput = function () {
            document.getElementById("channel").style.height = "";
            document.getElementById("channel").style.height = Math.min(document.getElementById("channel").scrollHeight, 300) + "px";
            localStorage.setItem("TwitchClipsChannels", this.value);
        };

        document.getElementById("mainChannel").oninput = function () {
            localStorage.setItem("TwitchClipsMainChannel", this.value);
        };

        document.getElementById("command").oninput = function () {
            localStorage.setItem("TwitchClipsCommand", this.value);
        };

        document.getElementById("customText").oninput = function () {
            localStorage.setItem("TwitchClipsCustomText", this.value);
        };

        document.getElementById("detailsText").oninput = function () {
            localStorage.setItem("TwitchClipsDetailsText", this.value);
        };

        document.getElementById("themeOption").onchange = function () {
            localStorage.setItem("TwitchClipsThemeOption", this.value);
        };

        document.getElementById("exclude").onchange = function () {
            localStorage.setItem("TwitchClipsExclude", this.value);
        };

        // Check if any input fields have changed
        $(":text,textarea,select,:checkbox,input[type=range],input[type=password]").on('change', function (e) {
            $("#overlaylink").addClass("hide");
        });

        //show following
        document.getElementById("showFollowing").addEventListener("click", function (e) {
            document.getElementById("channel").toggleAttribute('disabled');
        }, false);

        // show custom text input
        document.getElementById("showText").addEventListener("click", function (e) {
            document.getElementById("showCustomText").classList.toggle('hide');
        }, false);

        // show custom details input
        document.getElementById("showDetails").addEventListener("click", function (e) {
            document.getElementById("showDetailsText").classList.toggle('hide');
        }, false);

        // show custom details input
        document.getElementById("showFollowing").addEventListener("click", function (e) {
            document.getElementById("showExclude").classList.toggle('hide');
        }, false);

        document.getElementById("show_ref").addEventListener("click", function (e) {
            if (document.getElementById("show_ref").innerText === "hide") {
                document.getElementById("show_ref").innerText = "show";
                document.getElementById("ref").setAttribute('type', 'password');
            } else {
                document.getElementById("show_ref").innerText = "hide";
                document.getElementById("ref").setAttribute('type', 'text');
            }
        }, false);

        document.getElementById("generate_button").addEventListener("click", function (e) {
            let channel = document.getElementById("channel").value.trim();
            channel = channel.replace(/\s+/g, ""); // remove white space
            let mainChannel = document.getElementById("mainChannel").value.trim();
            let exclude = document.getElementById("exclude").value.trim();
            exclude = exclude.replace(/\s+/g, ""); // remove white space
            let ref = document.getElementById("ref").value.trim();
            let limit = document.getElementById("limit").value;
            let dateRange = document.getElementById("dateRange").value;
            let themeOption = document.getElementById("themeOption").value;
            let preferFeatured = document.getElementById("preferFeatured").checked;
            let showText = document.getElementById("showText").checked;
            let showDetails = document.getElementById("showDetails").checked;
            let showFollowing = document.getElementById("showFollowing").checked;
            let command = document.getElementById("command").value.trim();
            command = command.replace('!', '');
            let customText = document.getElementById("customText").value.trim();
            let detailsText = document.getElementById("detailsText").value.trim();
            let clientId = 'cuql1zod4eeabjr3cnc6adjn9ezro4';
            let validationError = false;

            if (showFollowing) {
                channel = '';
            }

            if (showFollowing && !ref) {
                alert('Twitch access token is required if show following is checked!');
            }

            if (!mainChannel) {
                alert('Twitch main channel is not set');
            }

            if (command && !mainChannel) {
                alert('Twitch main channel is not set');
            }

            if (showFollowing && !mainChannel) {
                alert('Twitch main channel is not set');
            }

            if (!channel && !showFollowing) {
                alert('Twitch channel(s) is not set or Show clips from channels that you follow is not checked');
            }

            let hardCodedCommands = ['clipplay', 'clippause', 'clipskip', 'clipreload'];

            if (hardCodedCommands.includes(command)) {
                alert(command + ' can not be used. It is a reserved command. Please choose a different command name.');
            }

            if (showDetails && !detailsText) {
                detailsText = "{title}\nWhile streaming {game}\nClipped by {creator_name} {created_at}";
            }

            if (showFollowing === false) {
                clientId = '';
                ref = '';
            }

            if (showFollowing === false) {
                exclude = '';
                clientId = '';
            }

            function validateForm() {
                const mainChannelInput = document.getElementById('mainChannel');
                const channelInput = document.getElementById('channel');
                const mainChannelValue = mainChannelInput.value;
                const channelValue = channelInput.value;
                const inputKeywords = ['http', 'https', 'twitch.tv'];

                inputKeywords.forEach(keyword => {
                    if (mainChannelValue.includes(keyword) || channelValue.includes(keyword)) {
                        alert(`Invalid input: Channel name cannot contain "${keyword}".`);
                        validationError = true;
                        return false;
                    }
                });

                return true;
            }

            validateForm();

            if (!validationError) {
                // build overlay url
                let srcURL = window.location.protocol + "//" + window.location.host + window.location.pathname;
                let fullUrl = srcURL + "clips.html?channel=" + channel + "&exclude=" + exclude + "&limit=" + limit + "&dateRange=" + dateRange + "&themeOption=" + themeOption + "&preferFeatured=" + preferFeatured + "&showText=" + showText + "&showDetails=" + showDetails + "&detailsText=" + encodeURIComponent(detailsText) + "&mainAccount=" + mainChannel + "&command=" + command + "&customText=" + encodeURIComponent(customText) + "&showFollowing=" + showFollowing + "&ref=" + btoa(ref) + "&clientId=" + btoa(clientId);
                fullUrl = fullUrl.replace("index.htmlclips.html", "clips.html");
                document.getElementById("overlaylink").classList.remove("hide");
                document.getElementById("overlaylink").innerHTML = "<p>Add this link as a browser source in OBS.<br>" +
                    "<a style='word-break:break-all;' href='" + fullUrl + "' target='_blank'>" + fullUrl + "</a><br><span class='text-warning'><small>* Never share this url with anyone or show it on stream!</small></span></p>";
            }

        });

        // Json data - Ajax call
        fetch("https://twitchapi.teklynk.com/getnav.php")
            .then(response => response.json())
            .then(nav_json => {
                $.each(nav_json, function (i, val) {
                    $('<a class="dropdown-item" href="' + val.url + '">' + val.name + '</a>').appendTo('#main-nav');
                });
            })
            .catch(error => console.error('Error loading navigation:', error));
    </script>
</body>

</html>